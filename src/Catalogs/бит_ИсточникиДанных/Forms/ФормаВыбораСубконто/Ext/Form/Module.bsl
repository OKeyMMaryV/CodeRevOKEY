

////bit auavseenkov++ Расчет отложенных налогов
//Создана дополнительная форма выбора.
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
  	       
	//Получим все реквизиты всех видов субконто
	МассивРеквизитов = Новый Массив;
	
	Если Параметры.Свойство("ИмяПараметра") Тогда 
		
		Если  Параметры.ИмяПараметра = "ТипДанныхНУОбъект"  Или Параметры.ИмяПараметра = "ТипДанныхБУОбъект" тогда  
			
			Выборка = ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Выбрать();
			
			ПолучитьМассивРеквизитов(Выборка, МассивРеквизитов);
			
			
		ИначеЕсли  Параметры.ИмяПараметра = "ТипДанныхМУОбъект" тогда 
			
			
			Выборка = ПланыВидовХарактеристик.бит_ВидыСубконтоДополнительные_2.Выбрать();
			
			ПолучитьМассивРеквизитов(Выборка, МассивРеквизитов);
			
			
		КонецЕсли;   
		
		//Создаем дерево выбора субконто 
		
		мДерево = РеквизитФормыВЗначение("РеквизитыСубконто");
		
		КоличествоСубконто = ?(Параметры.ИмяПараметра = "ТипДанныхНУОбъект",3,4);
		
		Для Сч = 1 по КоличествоСубконто Цикл 
			
			Строка = мДерево.Строки.Добавить();
			Строка.РеквизитОбъекта = "Субконто"+Сч;
						
			Для Каждого Эл из МассивРеквизитов Цикл 
				СтрокаСтрока = Строка.Строки.Добавить();
				СтрокаСтрока.РеквизитОбъекта = Эл;
			КонецЦикла;	
			
		КонецЦикла;
	КонецЕсли;
	ЗначениеВРеквизитФормы(мДерево,"РеквизитыСубконто");
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПолучитьМассивРеквизитов(Знач Выборка, Знач МассивРеквизитов)
	
	Пока Выборка.Следующий() Цикл 
        
        ТипЗначения = ТипЗнч(Выборка.ТипЗначения.ПривестиЗначение());
        
        Если ТипЗначения = Тип("Неопределено") Тогда 
            Продолжить;
        КонецЕсли;
        
		Если  Документы.ТипВсеСсылки().СодержитТип(ТипЗначения)  или
			Справочники.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда 
			Для Каждого ЭлРек из Метаданные.найтиПотипу(ТипЗначения).Реквизиты цикл
				
				Если ТипЗнч(ЭлРек.Тип.ПривестиЗначение()) = Тип("СправочникСсылка.ОбъектыСтроительства") Или 
					ТипЗнч(ЭлРек.Тип.ПривестиЗначение()) = Тип("ОписаниеТипов") Тогда
					
					Если ТипЗнч(ЭлРек.Тип.ПривестиЗначение()) = Тип("ОписаниеТипов") Тогда 
						Если ЭлРек.Тип.СодержитТип("СправочникСсылка.ОбъектыСтроительства") Тогда 
							
							
							Если МассивРеквизитов.Найти(ЭлРек.Имя)= Неопределено Тогда 
								
								МассивРеквизитов.Добавить(ЭлРек.Имя);    
								
							КонецЕсли;
						КонецЕсли;
					Иначе 	
						
						Если МассивРеквизитов.Найти(ЭлРек.Имя)= Неопределено Тогда 
							
							МассивРеквизитов.Добавить(ЭлРек.Имя);    
							
						КонецЕсли;
						
					КонецЕсли;
					
					
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;	
	КонецЦикла;


КонецПроцедуры

&НаКлиенте
Процедура РеквизитВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	
	ТекДанные = Элементы.Реквизит.ТекущиеДанные;
	Родитель = ТекДанные.ПолучитьРодителя();
	Выбор = ТекДанные.РеквизитОбъекта;
	Если Родитель  <> Неопределено Тогда 
		Если Найти(Родитель.РеквизитОбъекта,"Субконто")>0 Тогда 
			Выбор =  Родитель.РеквизитОбъекта+"." +Выбор;
		Иначе
			Выбор = Родитель.ПолучитьРодителя().РеквизитОбъекта +"."+ Родитель.РеквизитОбъекта+"." +Выбор;
		КонецЕсли;
	КонецЕсли;
	
	ЭтаФорма.Закрыть(Выбор);
	
КонецПроцедуры




