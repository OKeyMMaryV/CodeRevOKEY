#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

// Процедура - обработчик события "ПередЗаписью".
// 
Процедура ПередЗаписью(Отказ)

	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// +СБ. Широков Николай. 2016-06-21. Доработка #2444
	Регистратор = ЭтотОбъект.Отбор.Регистратор.Значение;
	
	//ОКЕЙ Поздняков А.С. (СофтЛаб) Начало 2020-10-26 (#ПроектИнтеграцияАксапта12)
	//Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.бит_ок_ОперацияАксапты") Тогда
	Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.бит_ок_ОперацияАксапты")
		ИЛИ ТипЗнч(Регистратор) = Тип("ДокументСсылка.бит_ок_ОперацияАксапты12") Тогда
	//ОКЕЙ Поздняков А.С. (СофтЛаб) Конец 2020-10-26 (#ПроектИнтеграцияАксапта12)
		
		РеквизитыДокумента 	= ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Регистратор, "Дата");
		ДатаДокумента 		= РеквизитыДокумента.Дата;
		
		Аналитика_Период 	= ПланыВидовХарактеристик.бит_ВидыСубконтоДополнительные_2.Периоды;
		ТекущийПериод 		= рс_ОбщийМодуль.ПолучитьМесяцНачисленияПоДате(ДатаДокумента);
		
		Если ТекущийПериод <> Неопределено Тогда
			Для каждого Проводка Из ЭтотОбъект Цикл
				
				Для Сч = 0 По 1 Цикл
					
					ДтКт = ?(Сч = 0, "Дт", "Кт");
					
					ПодменитьЗначениеПериода = Ложь;
					
					Для каждого Субконто Из Проводка["Субконто" + ДтКт] Цикл
						
						Если Субконто.Ключ = Аналитика_Период 
							И (Субконто.Значение = Справочники.рс_МесяцыНачисления.НеCопоставлено
							 ИЛИ НЕ ЗначениеЗаполнено(Субконто.Значение)) Тогда
							
							ПодменитьЗначениеПериода = Истина;	
						
						КонецЕсли; 
					КонецЦикла; 
					
					Если ПодменитьЗначениеПериода Тогда
						Проводка["Субконто" + ДтКт][Аналитика_Период] = ТекущийПериод; 
					КонецЕсли; 
				КонецЦикла; 
			КонецЦикла; 
		КонецЕсли; 
	КонецЕсли; 
// -СБ. Широков Николай 	

	//ОКЕЙ Поздняков А.С. (СофтЛаб) Начало 2021-01-18 (#4006)
	Если ОбменДанными.Загрузка 
		И (НЕ ЭтотОбъект.ДополнительныеСвойства.Свойство("ок_ВыполнитьЗакрытиеСчетов")
			ИЛИ НЕ ЭтотОбъект.ДополнительныеСвойства.ок_ВыполнитьЗакрытиеСчетов) Тогда
		
		Для каждого Проводка Из ЭтотОбъект Цикл
			
			Если НЕ (ЗначениеЗаполнено(Проводка.СчетДт) И Проводка.СчетДт.Валютный) Тогда
				Проводка.ВалютаДт = NULL;
			КонецЕсли;
			Если НЕ (ЗначениеЗаполнено(Проводка.СчетКт) И Проводка.СчетКт.Валютный) Тогда
				Проводка.ВалютаКт = NULL;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	//ОКЕЙ Поздняков А.С. (СофтЛаб) Конец 2021-01-18 (#4006)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Регистратор = ЭтотОбъект.Отбор.Регистратор.Значение;
	
	Если Количество()>0 Тогда
	    Заголовок = СокрЛП(Регистратор);
	КонецЕсли; 
	
	ВидыСоставныхСубконто = Новый Соответствие;
	ШаблонСообщения = Нстр("ru = 'Проводка № %1 <%2>: не заполнен счет %3.'");
	Для Каждого Проводка Из ЭтотОбъект Цикл
        
        СвСчДт = бит_БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетДт);
        СвСчКт = бит_БухгалтерскийУчетВызовСервераПовтИсп.ПолучитьСвойстваСчета(Проводка.СчетКт);
        
		Если НЕ ЗначениеЗаполнено(Проводка.СчетДт) И НЕ СвСчКт.Забалансовый Тогда
			ТекстСообщения = СтрШаблон(ШаблонСообщения, Формат(Проводка.НомерСтроки + 1,"ЧЦ=15; ЧГ="), Проводка.Содержание, Нстр("ru = 'дебета'")); 
			бит_ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения,Отказ,Заголовок);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Проводка.СчетКт) И НЕ СвСчДт.Забалансовый Тогда
			ТекстСообщения = СтрШаблон(ШаблонСообщения, Формат(Проводка.НомерСтроки + 1,"ЧЦ=15; ЧГ="), Проводка.Содержание, Нстр("ru = 'кредита'")); 
			бит_ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения,Отказ,Заголовок);
		КонецЕсли;
		
		бит_БухгалтерияСервер.КорректировкаПустыхЗначенийСубконто(Проводка.СубконтоДт, ВидыСоставныхСубконто);
		бит_БухгалтерияСервер.КорректировкаПустыхЗначенийСубконто(Проводка.СубконтоКт, ВидыСоставныхСубконто);
		
	КонецЦикла;

	бит_УправленческийУчет.ОбработатьПроводкиПоТипамПроводок(ЭтотОбъект, Регистратор);
	
КонецПроцедуры // ПередЗаписью()

#КонецОбласти

#КонецЕсли
