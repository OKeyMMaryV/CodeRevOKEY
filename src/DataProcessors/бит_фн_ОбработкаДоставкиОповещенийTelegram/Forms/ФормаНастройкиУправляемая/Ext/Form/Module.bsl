
#Область ОбработчикиСобытийФормы
	
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	МетаданныеОбъекта = Метаданные.Обработки.бит_фн_ОбработкаДоставкиОповещенийЭлПочта;
	
	// Вызов механизма защиты
	
	
	Если фОтказ Тогда
		Возврат;
	КонецЕсли;
	
	Если Параметры.Свойство("НастройкиДоставки") Тогда
	
		 Для каждого КиЗ Из Параметры.НастройкиДоставки Цикл
		 
		 	 ИмяРеквизита = "Настройка_"+КиЗ.Ключ;
			 Объект[ИмяРеквизита] = КиЗ.Значение;
		 
		 КонецЦикла; 
	
	КонецЕсли; 
	
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

// Процедура - обработчик Команды "ПоКнопкеОК".
// 
&НаКлиенте
Процедура ПоКнопкеОК(Команда)
	
	флНетОшибок = ПроверитьЗаполнение();
	
	Если флНетОшибок Тогда
		
		НастройкиДоставки = ОК_Сервер();
		ОповеститьОВыборе(НастройкиДоставки);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьТокен(Команда)
	
	КомандаПроверитьТокенНаСервере();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Процедура получате структуру настройки доставки.
// 
&НаСервере
Функция ОК_Сервер()
	
	ОбработкаОбъект   = ДанныеФормыВЗначение(Объект,Тип("ОбработкаОбъект.бит_фн_ОбработкаДоставкиОповещенийTelegram"));
	НастройкиДоставки = бит_фн_ОповещенияСервер.ПолучитьСтруктуруНастроекДоставки(ОбработкаОбъект);

	Возврат НастройкиДоставки;
	
КонецФункции // ОК_Сервер()

&НаСервере
Процедура КомандаПроверитьТокенНаСервере()
	
	Если НЕ ЗначениеЗаполнено(Объект.Настройка_Бот) Тогда
		
		ТекстСообщения =  НСтр("ru = 'Не заполнен бот!'");
		
	Иначе	
		
		РезультатПроверки = Справочники.бит_БотыTelegram.ПроверитьТокен(Объект.Настройка_Бот.Токен);
		
		Если РезультатПроверки.Существует Тогда
			
			ТекстСообщения =  НСтр("ru = 'Проверка выполнена успешно.'");
			
		Иначе	
			
			ТекстСообщения =  НСтр("ru = 'Ошибка выполнения проверки! %1%.'");
			ТекстСообщения = бит_ОбщегоНазначенияКлиентСервер.ПодставитьПараметрыСтроки(ТекстСообщения, РезультатПроверки.Сообщение);
			
		КонецЕсли; 
		
	КонецЕсли; 
	
	бит_ОбщегоНазначенияКлиентСервер.ВывестиСообщение(ТекстСообщения);
	
КонецПроцедуры

#КонецОбласти
