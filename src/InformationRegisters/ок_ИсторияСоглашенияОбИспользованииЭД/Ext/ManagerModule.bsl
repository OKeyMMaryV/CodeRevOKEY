//ОК(СофтЛаб) Вдовиченко Г.В. 20181101 №3103

Процедура ОбновитьИсторию(Соглашение) Экспорт
	
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
	//Если Не ЗначениеЗаполнено(Соглашение.Ссылка) Тогда
	//	Возврат;
	//КонецЕсли;
	Если НЕ ТипЗНЧ(Соглашение) = Тип("Структура") Тогда
		Возврат;
	КонецЕсли;	
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )
	
	УстановитьПривилегированныйРежим(Истина);
	ЕстьИзменения = Истина;
	Период = ТекущаяДатаСеанса();
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Данные.СостояниеСоглашения КАК СостояниеСоглашения,
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Начало 2019-10-02 (#3337)
	|	Данные.ДатаОкончания КАК ДатаОкончания,
	|	Данные.ДатаНачалаИсходящие КАК ДатаНачалаИсходящие,
	|	Данные.ДатаОкончанияИсходящие КАК ДатаОкончанияИсходящие,
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Конец 2019-10-02 (#3337)
	|	Данные.ДатаНачала КАК ДатаНачала
	|ИЗ
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
	//|	РегистрСведений.ок_ИсторияСоглашенияОбИспользованииЭД.СрезПоследних(&Период, Соглашение = &Соглашение) КАК Данные";
	//Запрос.УстановитьПараметр("Период", Период);
	//Запрос.УстановитьПараметр("Соглашение", Соглашение.Ссылка);
	|	РегистрСведений.ок_ИсторияСоглашенияОбИспользованииЭД.СрезПоследних(&Период, Отправитель = &Отправитель И Получатель = &Получатель
	//ОКЕЙ Бублик А.А.(СофтЛаб) Начало 2020-09-28 (#3879)
	|	И ИдентификаторОтправителя = &ИдентификаторОтправителя И ИдентификаторПолучателя = &ИдентификаторПолучателя
	//ОКЕЙ Бублик А.А.(СофтЛаб) Конец 2020-09-28 (#3879) 
	|) КАК Данные";
	Запрос.УстановитьПараметр("Период", Период);
	Запрос.УстановитьПараметр("Отправитель", Соглашение.Отправитель);
	Запрос.УстановитьПараметр("Получатель", Соглашение.Получатель);
	//ОКЕЙ Бублик А.А.(СофтЛаб) Начало 2020-09-28 (#3879) 
	Запрос.УстановитьПараметр("ИдентификаторОтправителя", Соглашение.ИдентификаторОтправителя);
	Запрос.УстановитьПараметр("ИдентификаторПолучателя", Соглашение.ИдентификаторПолучателя);
	//ОКЕЙ Бублик А.А.(СофтЛаб) Конец 2020-09-28 (#3879) 
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )
	РезультатЗапроса = Запрос.Выполнить();
	
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
	//ок_ДатаНачала = Соглашение.ок_ДатаНачала;
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )
	
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Начало 2019-10-02 (#3337)
	////Если Соглашение.ок_ОграничениеПотока = ПредопределенноеЗначение("Перечисление.НаправленияЭД.Входящий") Тогда
	////	ок_ДатаНачала = Соглашение.ок_ДатаНачалаВходящий;
	////ИначеЕсли Соглашение.ок_ОграничениеПотока = ПредопределенноеЗначение("Перечисление.НаправленияЭД.Исходящий") Тогда
	////	ок_ДатаНачала = Соглашение.ок_ДатаНачалаИсходящий;
	////КонецЕсли;	
	ПоследниеПериодыДействия = ок_ОбменСКонтрагентамиВнутренний.ПоследниеПериодыДействияСоглашенияОбИспользованияЭД(Соглашение);
	ок_ДатаНачала = ПоследниеПериодыДействия.ДатаНачала;
	ДатаОкончания = ПоследниеПериодыДействия.ДатаОкончания;
	ДатаНачалаИсходящие = ПоследниеПериодыДействия.ДатаНачалаИсходящие;
	ДатаОкончанияИсходящие = ПоследниеПериодыДействия.ДатаОкончанияИсходящие;
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Конец 2019-10-02 (#3337)
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
		//Если Выборка.СостояниеСоглашения = Соглашение.СостояниеСоглашения 
		Если Истина
		//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )	
			//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Начало 2019-10-02 (#3337)
			И Выборка.ДатаОкончания = ДатаОкончания
			И Выборка.ДатаНачалаИсходящие = ДатаНачалаИсходящие
			И Выборка.ДатаОкончанияИсходящие = ДатаОкончанияИсходящие
			//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Конец 2019-10-02 (#3337)
			И Выборка.ДатаНачала = ок_ДатаНачала Тогда //не меняется
			ЕстьИзменения = Ложь;
		КонецЕсли;	
	КонецЦикла;
	
	Если Не ЕстьИзменения Тогда
		Возврат;
	КонецЕсли;
	
	Набор = РегистрыСведений.ок_ИсторияСоглашенияОбИспользованииЭД.СоздатьНаборЗаписей();
	Набор.Отбор.Период.Установить(Период);
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
	//Набор.Отбор.Соглашение.Установить(Соглашение.Ссылка);
	Набор.Отбор.Отправитель.Установить(Соглашение.Отправитель);
	Набор.Отбор.Получатель.Установить(Соглашение.Получатель);
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )
	Запись = Набор.Добавить();
	Запись.Период = Период;
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО (
	//Запись.Соглашение = Соглашение.Ссылка;
	//Запись.СостояниеСоглашения = Соглашение.СостояниеСоглашения;
	Запись.Отправитель =Соглашение.Отправитель;
	Запись.Получатель = Соглашение.Получатель;
	//1С-ИжТиСи, Кондратьев, 03.2020, обновление ЭДО )
	Запись.ДатаНачала = ок_ДатаНачала;
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Начало 2019-08-12 (#3337)
	Запись.ДатаОкончания = ДатаОкончания;
	Запись.ДатаНачалаИсходящие = ДатаНачалаИсходящие;
	Запись.ДатаОкончанияИсходящие = ДатаОкончанияИсходящие;
	//ОКЕЙ Вдовиченко Г.В(СофтЛаб) Конец 2019-08-12 (#3337)
	
	//ОКЕЙ Бублик А.А.(СофтЛаб) Начало 2020-09-28 (#3879)
	Запись.ИдентификаторОтправителя = Соглашение.ИдентификаторОтправителя;
	Запись.ИдентификаторПолучателя =  Соглашение.ИдентификаторПолучателя;
	//ОКЕЙ Бублик А.А.(СофтЛаб) Конец 2020-09-28 (#3879)
	
	Набор.Записать();
	
КонецПроцедуры	
