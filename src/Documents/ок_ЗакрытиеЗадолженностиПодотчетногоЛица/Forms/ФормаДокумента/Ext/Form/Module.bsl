//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Начало 2021-09-14 (#ТП_БП05_ФР16)
#Область ОписаниеПеременных

&НаКлиенте 
Перем мКэшРеквизитовФормы;

#КонецОбласти
//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Конец 2021-09-14 (#ТП_БП05_ФР16)

//ОКЕЙ Дмитриева В.В. (ПервыйБИТ) Начало 2021-06-01 (#ТП_БП05_ФР16)

#Область ОбработчикиСобытийЭлементовТаблицыФормыОстатки

&НаКлиенте
Процедура ДолгиКомпанииДокументРасчетовНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("Организация",     Объект.Организация);
	ПараметрыОткрытия.Вставить("Валюта",          Объект.Валюта);
	ПараметрыОткрытия.Вставить("Дата",            Объект.Дата);
	ПараметрыОткрытия.Вставить("ПодотчетноеЛицо", Объект.ПодотчетноеЛицо);
	ПараметрыОткрытия.Вставить("ДокументыРасчетов", ПолучитьМассивДокументовРасчетов("ДолгиКомпании"));
	ПараметрыОткрытия.Вставить("ИмяТЧ", "ДолгиКомпании");
	ПараметрыОткрытия.Вставить("Ссылка", Объект.Ссылка);
	
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборДокументаОстатка", ЭтотОбъект);

	ОткрытьФорму("Документ.ок_ЗакрытиеЗадолженностиПодотчетногоЛица.Форма.ФормаПодбораДокументов", ПараметрыОткрытия, ЭтаФорма,,,,ОписаниеОповещенияОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
КонецПроцедуры

&НаКлиенте
Процедура ДолгиСотрудникаДокументРасчетовНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("Организация",     Объект.Организация);
	ПараметрыОткрытия.Вставить("Валюта",          Объект.Валюта);
	ПараметрыОткрытия.Вставить("Дата",            Объект.Дата);
	ПараметрыОткрытия.Вставить("ПодотчетноеЛицо", Объект.ПодотчетноеЛицо);
	ПараметрыОткрытия.Вставить("ДокументыРасчетов", ПолучитьМассивДокументовРасчетов("ДолгиСотрудника"));
	ПараметрыОткрытия.Вставить("ИмяТЧ", "ДолгиСотрудника");
	ПараметрыОткрытия.Вставить("Ссылка", Объект.Ссылка);

	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборДокументаОстатка", ЭтотОбъект);

	ОткрытьФорму("Документ.ок_ЗакрытиеЗадолженностиПодотчетногоЛица.Форма.ФормаПодбораДокументов", ПараметрыОткрытия, ЭтаФорма,,,,ОписаниеОповещенияОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
КонецПроцедуры

&НаКлиенте
Процедура ДолгиСотрудникаПередНачаломИзменения(Элемент, Отказ)
	Если Элемент.ТекущийЭлемент.Имя =  "ДолгиСотрудникаДокументРасчетов" Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыОткрытия = Новый Структура;
		ПараметрыОткрытия.Вставить("Организация",     Объект.Организация);
		ПараметрыОткрытия.Вставить("Валюта",          Объект.Валюта);
		ПараметрыОткрытия.Вставить("Дата",            Объект.Дата);
		ПараметрыОткрытия.Вставить("ПодотчетноеЛицо", Объект.ПодотчетноеЛицо);
		ПараметрыОткрытия.Вставить("ДокументыРасчетов", ПолучитьМассивДокументовРасчетов("ДолгиСотрудника"));
		ПараметрыОткрытия.Вставить("ИмяТЧ", "ДолгиСотрудника");
		ПараметрыОткрытия.Вставить("Ссылка", Объект.Ссылка);

		ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборДокументаОстатка", ЭтотОбъект);

		ОткрытьФорму("Документ.ок_ЗакрытиеЗадолженностиПодотчетногоЛица.Форма.ФормаПодбораДокументов", ПараметрыОткрытия, ЭтаФорма,,,,ОписаниеОповещенияОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	ИначеЕсли Элемент.ТекущийЭлемент.Имя =  "ДолгиСотрудникаСуммаКЗачету" Тогда
		ЭтотОбъект.СуммаЗачетаДоИзменения = элемент.ТекущиеДанные.СуммаЗачета;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДолгиКомпанииПередНачаломИзменения(Элемент, Отказ)
	Если Элемент.ТекущийЭлемент.Имя =  "ДолгиКомпанииДокументРасчетов" Тогда
		СтандартнаяОбработка = Ложь;
		ПараметрыОткрытия = Новый Структура;
		ПараметрыОткрытия.Вставить("Организация",     Объект.Организация);
		ПараметрыОткрытия.Вставить("Валюта",          Объект.Валюта);
		ПараметрыОткрытия.Вставить("Дата",            Объект.Дата);
		ПараметрыОткрытия.Вставить("ПодотчетноеЛицо", Объект.ПодотчетноеЛицо);
		ПараметрыОткрытия.Вставить("ДокументыРасчетов", ПолучитьМассивДокументовРасчетов("ДолгиСотрудника"));
		ПараметрыОткрытия.Вставить("ИмяТЧ", "ДолгиКомпании");
		ПараметрыОткрытия.Вставить("Ссылка", Объект.Ссылка);

		ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборДокументаОстатка", ЭтотОбъект);

		ОткрытьФорму("Документ.ок_ЗакрытиеЗадолженностиПодотчетногоЛица.Форма.ФормаПодбораДокументов", ПараметрыОткрытия, ЭтаФорма,,,,ОписаниеОповещенияОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	ИначеЕсли Элемент.ТекущийЭлемент.Имя =  "ДолгиКомпанииСуммаКЗачету" Тогда
	ЭтотОбъект.СуммаЗачетаДоИзменения = элемент.ТекущиеДанные.СуммаЗачета;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДолгиСотрудникаПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	ПроверитьСуммуЗачета(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьСуммуЗачета(Элемент)
	Если Элемент.ТекущиеДанные.СуммаЗачета>Элемент.ТекущиеДанные.Сумма Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю("Значение в поле ""Сумма зачета"" не должно превышать значение в поле ""Сумма"" (остаток задолженности по документу расчетов)");
		Элемент.ТекущиеДанные.СуммаЗачета = ЭтотОбъект.СуммаЗачетаДоИзменения;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДолгиКомпанииПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	ПроверитьСуммуЗачета(Элемент);
КонецПроцедуры


#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаполнитьОстаткиДолгиСотрудника(Команда)
	Если Объект.Проведен Тогда
		ТекстСообщения = НСтр("ru= 'Документ проведен. Для заполнения табличной части необходимо отменить проведение.'");
		ОбщегоНазначенияКлиент.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	Если ПроверитьЗаполнение() Тогда
		ЗаполнитьОстаткиНаСервере("ДолгиСотрудника");		
	КонецЕсли;
	
КонецПроцедуры
&НаКлиенте
Процедура ЗаполнитьОстаткиДолгиКомпании(Команда)
	Если Объект.Проведен Тогда
		ТекстСообщения = НСтр("ru= 'Документ проведен. Для заполнения табличной части необходимо отменить проведение.'");
		ОбщегоНазначенияКлиент.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;

	Если ПроверитьЗаполнение() Тогда
		ЗаполнитьОстаткиНаСервере("ДолгиКомпании");		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции
&НаСервере
Процедура ЗаполнитьОстаткиНаСервере(ИмяТЧ)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР
		|		КОГДА &ЭтоДолгиСотрудника
		|			ТОГДА ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток
		|		ИНАЧЕ -ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток
		|	КОНЕЦ КАК Сумма,
		|	ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.ДокументРасчетов КАК ДокументРасчетов,
		|	ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.ДенежныйДокумент КАК ДенежныйДокумент,
		|	ВЫБОР
		|		КОГДА &ЭтоДолгиСотрудника
		|			ТОГДА ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаРеглОстаток
		|		ИНАЧЕ -ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаРеглОстаток
		|	КОНЕЦ КАК СуммаРегл,
		|	ВЫБОР
		|		КОГДА &ЭтоДолгиСотрудника
		|			ТОГДА ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток
		|		ИНАЧЕ -ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток
		|	КОНЕЦ КАК СуммаЗачета
		|ИЗ
		|	РегистрНакопления.ок_ВзаиморасчетыСПодотчетнымиЛицами.Остатки(
		|			&ДатаДокумента,
		|			Организация = &Организация
		|				И Валюта = &Валюта
		|				И ПодотчетноеЛицо = &ПодотчетноеЛицо) КАК ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки
		|ГДЕ
		|	ВЫБОР
		|			КОГДА &ЭтоДолгиСотрудника
		|				ТОГДА ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток > 0
		|			ИНАЧЕ ок_ВзаиморасчетыСПодотчетнымиЛицамиОстатки.СуммаОстаток < 0
		|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("Валюта",          Объект.Валюта);
	//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Начало 2021-07-20 (#ТП_БП05_ФР16)
	// изменено
	//Запрос.УстановитьПараметр("ДатаДокумента",   Объект.Дата);
	Если НачалоДня(Объект.Дата) = НачалоДня(ОбщегоНазначения.ТекущаяДатаПользователя()) Тогда
		Запрос.УстановитьПараметр("ДатаДокумента",   Неопределено);
	Иначе	
		//Запрос.УстановитьПараметр("ДатаДокумента", Новый Граница(Объект.Ссылка.МоментВремени(), ВидГраницы.Исключая));
		Запрос.УстановитьПараметр("ДатаДокумента", Новый Граница(Объект.Дата, ВидГраницы.Исключая));
	КонецЕсли;
	//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Конец 2021-07-20 (#ТП_БП05_ФР16)
	Запрос.УстановитьПараметр("Организация",     Объект.Организация);
	Запрос.УстановитьПараметр("ПодотчетноеЛицо", Объект.ПодотчетноеЛицо);
	Если ИмяТЧ="ДолгиСотрудника" Тогда
	Запрос.УстановитьПараметр("ЭтоДолгиСотрудника", Истина);
	Иначе
	Запрос.УстановитьПараметр("ЭтоДолгиСотрудника", Ложь);
	КонецЕсли;
	
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Объект[ИмяТЧ].Загрузить(РезультатЗапроса.Выгрузить());
КонецПроцедуры

&НаСервере
Функция ПолучитьМассивДокументовРасчетов(ИмяТЧ)
	 Возврат Объект[ИмяТЧ].Выгрузить().ВыгрузитьКолонку("ДокументРасчетов");
КонецФункции

&НаКлиенте
Процедура ВыборДокументаОстатка(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	НоваяСтрока = Ложь;
	Если ТипЗнч(РезультатЗакрытия) = Тип("Структура") Тогда
		Для Каждого СтрокаМассива Из РезультатЗакрытия.МассивСтрок Цикл
			Если НоваяСтрока Тогда
				ТекСтрока = Объект[РезультатЗакрытия.ИмяТЧ].Добавить();
			    НоваяСтрока = Истина;
			Иначе
				ТекДанные = Элементы[РезультатЗакрытия.ИмяТЧ].ТекущиеДанные;
				ТекСтрока = Объект[РезультатЗакрытия.ИмяТЧ][ТекДанные.НомерСтроки-1];
				НоваяСтрока = Истина;
			КонецЕсли;
			ЗаполнитьЗначенияСвойств(ТекСтрока, СтрокаМассива);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ БСП

// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
	ПодключаемыеКомандыКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаСервере
Процедура Подключаемый_ВыполнитьКомандуНаСервере(Контекст, Результат) Экспорт
	ПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, Контекст, Объект, Результат);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры

// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
#КонецОбласти     
//ОКЕЙ Дмитриева В.В. (ПервыйБИТ) Конец 2021-06-01 (#ТП_БП05_ФР16)


//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Начало 2021-09-14 (#ТП_БП05_ФР16)
#Область ОбластьСобытияФормы
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Зададим имена реквизитов, подлежащих кешированию.
	мКэшРеквизитовФормы = Новый Структура;
	мКэшРеквизитовФормы.Вставить("Дата");
	мКэшРеквизитовФормы.Вставить("Организация");
	мКэшРеквизитовФормы.Вставить("Валюта");
	мКэшРеквизитовФормы.Вставить("ПодотчетноеЛицо");
	
	// Запомним текущие значения реквизитов формы.
	ЗаполнитьТекущиеЗначенияРеквизитовФормы();

КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	ОбработатьИзменениеРеквизита("Дата");
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	ОбработатьИзменениеРеквизита("Организация");
КонецПроцедуры

&НаКлиенте
Процедура ПодотчетноеЛицоПриИзменении(Элемент)
	ОбработатьИзменениеРеквизита("ПодотчетноеЛицо");
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	ОбработатьИзменениеРеквизита("Валюта");
КонецПроцедуры


&НаКлиенте
Процедура ОбработатьИзменениеРеквизита(ИмяРеквизита)
	ТекущееЗначениеРеквизита = мКэшРеквизитовФормы[ИмяРеквизита];
	Если ТекущееЗначениеРеквизита = Объект[ИмяРеквизита] Тогда
		Возврат;
	КонецЕсли;
	ПараметрыОповещения = Новый Структура("ИмяРеквизита, ТекущееЗначениеРеквизита", ИмяРеквизита, ТекущееЗначениеРеквизита);
	ОповещениеВопрос = Новый ОписаниеОповещения("ВопросРеквизитПриИзменении", ЭтотОбъект, ПараметрыОповещения);
	Если Объект.ДолгиСотрудника.Количество() > 0 
		или Объект.ДолгиКомпании.Количество() >0 Тогда
		ТекстВопроса = НСтр("ru = 'Изменен реквизит "+ИмяРеквизита+". Данные табличных частей Долги сотрудника и Долги компании будут очищены. Продолжить?'");
		ПоказатьВопрос(ОповещениеВопрос, ТекстВопроса, РежимДиалогаВопрос.ДаНет, 15, КодВозвратаДиалога.Нет);
	Иначе
		ДобавитьВКэш(ИмяРеквизита);
	КонецЕсли;

КонецПроцедуры
// Обработка оповещения вопроса пользователю. 
// 
// Параметры:
//  Ответ - Строка.
// 
&НаКлиенте
Процедура ВопросРеквизитПриИзменении(Ответ, ПараметрыОповещения) Экспорт

	Если Ответ = КодВозвратаДиалога.Да Тогда 			
		Объект.ДолгиКомпании.Очистить(); 
		Объект.ДолгиСотрудника.Очистить();  					
	Иначе
		Объект[ПараметрыОповещения.ИмяРеквизита] = ПараметрыОповещения.ТекущееЗначениеРеквизита;
	КонецЕсли;

	ДобавитьВКэш(ПараметрыОповещения.ИмяРеквизита);
	
КонецПроцедуры

#КонецОбласти

#Область РаботаСКэшемРеквизитовФормы

// Процедура заполняет кэш реквизитов формы данными объекта.
// 
// Параметры:
//  Нет.
// 
&НаКлиенте 
Процедура ЗаполнитьТекущиеЗначенияРеквизитовФормы()
	
	Для Каждого КлючИЗначение Из мКэшРеквизитовФормы Цикл
		мКэшРеквизитовФормы[КлючИЗначение.Ключ] = Объект[КлючИЗначение.Ключ];
	КонецЦикла; 
	
КонецПроцедуры

// Процедура добавляет в кэш реквизитов текущее значение заданного реквизита.
// 
// Параметры:
// 	ИмяРеквизита - Строка.
// 
&НаКлиенте
Процедура ДобавитьВКэш(ИмяРеквизита)
	
	мКэшРеквизитовФормы[ИмяРеквизита] = Объект[ИмяРеквизита];	
	
КонецПроцедуры

// Процедура извлекает из кэша и присваивает объекту значение заданного реквизита.
// 
// Параметры:
// 	ИмяРеквизита - Строка.
// 
&НаКлиенте
Процедура ИзвлечьИзКэша(ИмяРеквизита)
	
	Объект[ИмяРеквизита] = мКэшРеквизитовФормы[ИмяРеквизита];
	
КонецПроцедуры

#КонецОбласти
//ОКЕЙ Завьялова Е.А. (ПервыйБИТ) Конец 2021-09-14 (#ТП_БП05_ФР16)
