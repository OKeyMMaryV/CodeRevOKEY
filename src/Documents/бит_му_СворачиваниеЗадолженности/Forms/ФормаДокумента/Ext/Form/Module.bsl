
// Процедура - обработчик события "ПриОткрытии" формы.
//
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Объект.ДатаСторно = НачалоМесяца(Дата(Год(ДобавитьМесяц(Объект.Дата,1)), Месяц(ДобавитьМесяц(Объект.Дата,1)), 1));	
	
	// Вывести в заголовке формы вид операции и статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента();
	
	УстановитьДоступностьДаты();
		
КонецПроцедуры

// Процедура устнавливает заголовок формы документа.
//
// Параметры:
//  Нет.
//
&НаКлиенте 
Процедура УстановитьЗаголовокФормыДокумента()
	
	СтруктураЗаголовка = Новый Структура;
	СтруктураЗаголовка.Вставить("ПредставлениеОбъекта", фКэшЗначений.ПредставлениеОбъекта);
	СтруктураЗаголовка.Вставить("СтрокаВидаОперации"  , Строка(Объект.ВидОперации));
	СтруктураЗаголовка.Вставить("ЭтоНовый"			  , Параметры.Ключ.Пустая());
	СтруктураЗаголовка.Вставить("ДокументПроведен"	  , Объект.Проведен);
	
	бит_РаботаСДиалогамиКлиент.УстановитьЗаголовокФормыДокумента(ЭтаФорма
																,СтруктураЗаголовка);
	
КонецПроцедуры // УстановитьЗаголовокФормыДокумента()
															

// Процедура - обработчик события "ПриСозданииНаСервере" формы.
//
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// стандартные действия при создании на сервере
	бит_РаботаСДиалогамиСервер.ФормаОбъектаПриСозданииНаСервере(Отказ, СтандартнаяОбработка, ЭтаФорма, Объект);
	
	фКоличествоСубконтоМУ = 4;
	
	МетаданныеОбъекта = Объект.Ссылка.Метаданные();
	
	// Вызов механизма защиты.
	бит_ЛицензированиеБФCервер.ПроверитьВозможностьРаботы(ЭтаФорма, МетаданныеОбъекта.ПолноеИмя(), Отказ);
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли; 	
	
	// Заполняем кэш значений.
	ЗаполнитьКэшЗначений(фКэшЗначений);
	
	// Установим заголовки в таблице, установим видимость колонок
	НастроитьТабличнуюЧастьПоВидамОперации();
	
КонецПроцедуры

&НаСервере
Процедура ПроверкаСуществованияАналогичныхДокументов(Существует)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	бит_му_СворачиваниеЗадолженности.Ссылка
	               |ИЗ
	               |	Документ.бит_му_СворачиваниеЗадолженности КАК бит_му_СворачиваниеЗадолженности
	               |ГДЕ
	               |	бит_му_СворачиваниеЗадолженности.Дата МЕЖДУ &ДатаНач И &ДатаКон
	               |	И бит_му_СворачиваниеЗадолженности.ВидОперации = &ВидОперации";
	Запрос.УстановитьПараметр("ДатаНач", НачалоМесяца(Объект.Дата));				   
	Запрос.УстановитьПараметр("ДатаКон", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("ВидОперации", Объект.ВидОперации);
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Существует = Истина;
		Сообщить("В данном месяце уже существуют следующие документы с видом операции " + Строка(Объект.ВидОперации) + " :", СтатусСообщения.Важное);
		ВыборкаРез = Результат.Выбрать();
		Пока ВыборкаРез.Следующий() Цикл
			Сообщить(Строка(ВыборкаРез.Ссылка));
		КонецЦикла;
		Сообщить("Документ создан не будет");
	КонецЕсли;
	
КонецПроцедуры

// Процедура заполняет кэш значений, необходимый при работе на клиенте.
//
// Параметры:
//  КэшированныеЗначения - Структура.
//
&НаСервере
Процедура ЗаполнитьКэшЗначений(КэшированныеЗначения)
	
	КэшированныеЗначения = Новый Структура;
	
	// Перечисления.
	КэшПеречисления = Новый Структура;
	КэшПеречисления.Вставить("бит_му_ВидыОперацийСворачиваниеЗадолженности", бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности));
	
	КэшированныеЗначения.Вставить("Перечисления", КэшПеречисления);
		
	// Запишем параметр для формирования заголовка.
	КэшированныеЗначения.Вставить("ПредставлениеОбъекта", Объект.Ссылка.Метаданные().Представление());
		
КонецПроцедуры // ЗаполнитьКэшЗначений()


&НаКлиенте
Процедура ЗаполнитьТЧ(Команда)
	
	Если Объект.Проведен Тогда
		Сообщить("Перед заполнением таблицы требуется распровести документ"); 
		Возврат;		
	КонецЕсли;
	
	Если Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПретензиям Тогда
		
		МассивНастроек = Новый Массив;
		МассивНастроек.Добавить("Счет расчета по претензиям");
		МассивНастроек.Добавить("Счет учета КЗ по товару");
		
		бит_му_ОбщийКлиент.ДозаполнитьНедостающиеНастройки(МассивНастроек, "Вспомогательные счета сворачивания");
		
	ИначеЕсли Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамПоставки Тогда
		
		МассивНастроек = Новый Массив;
		МассивНастроек.Добавить("Счет ДЗ по премиям по договорам поставки");
		МассивНастроек.Добавить("Счет учета КЗ по товару");
		
		бит_му_ОбщийКлиент.ДозаполнитьНедостающиеНастройки(МассивНастроек, "Вспомогательные счета сворачивания");
		
	ИначеЕсли Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ПереносСальдоНаОдинДоговорДляСворачиванияЗадолженности Тогда

		МассивНастроек = Новый Массив;
		МассивНастроек.Добавить("Счет ДЗ по премиям по договорам маркетинга"); //52108
		МассивНастроек.Добавить("Счет учета КЗ по товару");//52101
		МассивНастроек.Добавить("Счет ДЗ по работам и услугам"); //22102
		
		бит_му_ОбщийКлиент.ДозаполнитьНедостающиеНастройки(МассивНастроек, "Вспомогательные счета сворачивания");
		
	ИначеЕсли Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамМаркетинга Тогда

		МассивНастроек = Новый Массив;
		МассивНастроек.Добавить("Счет ДЗ по премиям по договорам маркетинга");
		МассивНастроек.Добавить("Счет учета КЗ по товару");
		
		бит_му_ОбщийКлиент.ДозаполнитьНедостающиеНастройки(МассивНастроек, "Вспомогательные счета сворачивания");
		
	ИначеЕсли Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоУслугам Тогда
		
		МассивНастроек = Новый Массив;
		МассивНастроек.Добавить("Счет ДЗ по работам и услугам");
		МассивНастроек.Добавить("Счет учета КЗ по товару");
		
		бит_му_ОбщийКлиент.ДозаполнитьНедостающиеНастройки(МассивНастроек, "Вспомогательные счета сворачивания");
		
	КонецЕсли;
	
	ЗаполнитьТЧНаСервере();
	
	РассчитатьОбщиеСуммы();
	
	Объект.Рассчитано = Ложь;
	Элементы.ТЧПретензии.ИзменятьСоставСтрок = Истина;
	
	УстановитьДоступностьДаты();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТЧНаСервере()
	
	Если Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПретензиям Тогда
		Таблица = ПолучитьТаблицуПоПретензиям();
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамПоставки Тогда
		Таблица = ПолучитьТаблицуПоПремиямПоПоставкам();
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ПереносСальдоНаОдинДоговорДляСворачиванияЗадолженности Тогда
		Таблица = ПолучитьТаблицуПереносСальдо();
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамМаркетинга Тогда
		Таблица = ПолучитьТаблицуПоПремиямПоМаркетингу();
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоУслугам Тогда
		Таблица = ПолучитьТаблицуПоУслугам();
		// ОКЕЙ Чернов И.Е.(СофтЛаб) Начало 2019-05-15 (#3440)	  
	Иначе
		РеквизитыДокумента = Новый Структура;
		РеквизитыДокумента.Вставить("Организация", Объект.Организация);
		РеквизитыДокумента.Вставить("Дата", Объект.Дата);
		РеквизитыДокумента.Вставить("ВидОперации", Объект.ВидОперации);
		Таблица = ОК_бит_МеханизмСворачиванияДЗКЗ.ПолучитьТаблицуСвертки(РеквизитыДокумента);
		// ОКЕЙ Чернов И.Е.(СофтЛаб) Конец 2019-05-15 (#3440)		
	КонецЕсли;
	
	Если Таблица.Количество() > 0 Тогда
		Объект.ТЧПретензии.Очистить();
	КонецЕсли;
	
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		НоваяСтрокаТЧ = Объект.ТЧПретензии.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтрокаТаблицы);
	КонецЦикла;
	
	Если Объект.ТЧПретензии.Количество() > 0 Тогда
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТаблицуПоПретензиям()
	
	 НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	 НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	 НаборНастроек.Прочитать();
	 
	 ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();
	 
	 СчетаРасчетаПоПретензиям = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет расчета по претензиям"));
	 
	 Если СчетаРасчетаПоПретензиям.Количество() > 0 Тогда
		 СчетРасчетаПоПретензиям = СчетаРасчетаПоПретензиям[0].Значение;
	 КонецЕсли;
	 
	 СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	 
	 Если СчетаРасчетаПоПретензиям.Количество() > 0 Тогда
	 	СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение;
	 КонецЕсли;                   
	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТПретензии
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетПретензий, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТКЗПоТовару
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетКЗПоТовару, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТовару.Договоры КАК Договор,
	                |	ВТКЗПоТовару.Контрагент,
	                |	ВТКЗПоТовару.Счет КАК СчетУчетаКЗ,
	                |	ВТПретензии.Счет КАК СчетРасчетаПоПретензиям,
	                |	ВТКЗПоТовару.СуммаМУОстаток КАК СальдоПоСчетуУчетаКЗ,
	                |	ВТПретензии.СуммаМУОстаток КАК СальдоПоСчетуРасчетаПоПретензиям,
	                |	ВЫБОР
	                |		КОГДА ВТКЗПоТовару.СуммаМУОстаток >= 0
	                |			ТОГДА ВЫБОР
	                |					КОГДА ВТКЗПоТовару.СуммаМУОстаток < ВТПретензии.СуммаМУОстаток
	                |						ТОГДА ВТКЗПоТовару.СуммаМУОстаток
	                |					ИНАЧЕ ВТПретензии.СуммаМУОстаток
	                |				КОНЕЦ
	                |		ИНАЧЕ 0
	                |	КОНЕЦ КАК СуммаСворачивания,
	                |	ВТПретензии.Договоры,
	                |	ВТКЗПоТовару.Контрагент.Код КАК КодКонтрагента
	                |ИЗ
	                |	ВТПретензии КАК ВТПретензии
	                |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКЗПоТовару КАК ВТКЗПоТовару
	                |		ПО ВТПретензии.Договоры = ВТКЗПоТовару.Договоры";
					
	Запрос.УстановитьПараметр("СчетПретензий", СчетРасчетаПоПретензиям);						
	Запрос.УстановитьПараметр("СчетКЗПоТовару", СчетУчетаКЗ);
	мПараметры = Новый Массив(2);
	мПараметры[0] = КонецДня(Объект.Дата);
	мПараметры[1] = ВидГраницы.Включая;
	Граница = Новый(Тип("Граница"),мПараметры);
	Запрос.УстановитьПараметр("ДатаОстатков", Граница);
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Таблица = Запрос.Выполнить().Выгрузить();

	Возврат Таблица; 
	     	
КонецФункции

&НаСервере
Функция ПолучитьТаблицуПоПремиямПоПоставкам()
	
	НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	НаборНастроек.Прочитать();
	
	ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();

	
	 СчетаУчетаДЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по премиям по договорам поставки"));
	 
	 Если СчетаУчетаДЗ.Количество() > 0 Тогда
		 СчетУчетаДЗ = СчетаУчетаДЗ[0].Значение;
	 КонецЕсли;
	 
	 СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	 
	 Если СчетаУчетаКЗ.Количество() > 0 Тогда
		 СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение;
	 КонецЕсли;
	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(бит_Дополнительный_2Остатки.СуммаМУОстаток) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТПретензии
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаДт, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТКЗПоТовару
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаКЗ, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТовару.Договоры КАК ДоговорКЗ,
	                |	ВТКЗПоТовару.Контрагент КАК КонтрагентКЗ,
	                |	ВЫБОР
	                |		КОГДА ВТКЗПоТовару.Счет ЕСТЬ NULL 
	                |			ТОГДА &СчетУчетаКЗ
	                |		ИНАЧЕ ВТКЗПоТовару.Счет
	                |	КОНЕЦ КАК СчетУчетаКЗ,
	                |	ВТПретензии.Счет КАК СчетРасчетаПоПретензиям,
	                |	ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0) КАК СальдоПоСчетуУчетаКЗ,
	                |	ВТПретензии.СуммаМУОстаток КАК СальдоПоСчетуРасчетаПоПретензиям,
	                |	ВЫБОР
	                |		КОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0) <= ВТПретензии.СуммаМУОстаток
	                |			ТОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0)
	                |		ИНАЧЕ ВТПретензии.СуммаМУОстаток
	                |	КОНЕЦ КАК СуммаСворачивания,
	                |	ВЫБОР
	                |		КОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0) > ВТПретензии.СуммаМУОстаток
	                |			ТОГДА 0
	                |		ИНАЧЕ ВТПретензии.СуммаМУОстаток - ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0)
	                |	КОНЕЦ КАК СуммаОтнесения,
	                |	ВТПретензии.Договоры КАК Договор,
	                |	ВТПретензии.Контрагент КАК Контрагент,
	                |	ВТПретензии.Контрагент.Код КАК КодКонтрагента
	                |ИЗ
	                |	ВТПретензии КАК ВТПретензии
	                |		ЛЕВОЕ СОЕДИНЕНИЕ ВТКЗПоТовару КАК ВТКЗПоТовару
	                |		ПО ВТПретензии.Договоры = ВТКЗПоТовару.Договоры
	                |ГДЕ
	                |	НЕ ВТПретензии.Договоры ЕСТЬ NULL ";

	Запрос.УстановитьПараметр("СчетУчетаДт", СчетУчетаДЗ);						
	Запрос.УстановитьПараметр("СчетУчетаКЗ", СчетУчетаКЗ);
	мПараметры = Новый Массив(2);
	мПараметры[0] = КонецДня(Объект.Дата);
	мПараметры[1] = ВидГраницы.Включая;
	Граница = Новый(Тип("Граница"),мПараметры);
	Запрос.УстановитьПараметр("ДатаОстатков", Граница);
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Таблица = Запрос.Выполнить().Выгрузить();

	Возврат Таблица;				
	
КонецФункции

&НаСервере
Функция ПолучитьТаблицуПереносСальдо()
	
	НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	НаборНастроек.Прочитать();
	
	ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();

	
	 СчетаУчетаДЗПереносСальдо = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по премиям по договорам маркетинга"));
	 
	 Если СчетаУчетаДЗПереносСальдо.Количество() > 0 Тогда
		 СчетУчетаДЗПереносСальдо = СчетаУчетаДЗПереносСальдо[0].Значение; //52108
	 КонецЕсли;
	 
	 СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	 
	 Если СчетаУчетаКЗ.Количество() > 0 Тогда
		 СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение; //52101
	 КонецЕсли;
	 
	 СчетаУчетаДЗРаботыУслуги = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по работам и услугам"));
	 
	 Если СчетаУчетаДЗРаботыУслуги.Количество() > 0 Тогда
		 СчетУчетаДЗРаботыУслуги = СчетаУчетаДЗРаботыУслуги[0].Значение; //22102
	 КонецЕсли;
	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(бит_Дополнительный_2Остатки.СуммаМУОстаток) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТПремии
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет В (&СчетУчетаДтПереносСальдо, &СчетУчетаДЗРаботыУслуги), , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТПретензии.Счет,
	                |	ВТПретензии.Контрагент,
	                |	ВТПретензии.Договоры,
	                |	ВТПретензии.СуммаМУОстаток,
	                |	ДоговорыКонтрагентов.бит_НомерАХ КАК НомерАкс,
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |ПОМЕСТИТЬ ВТПремииСИННКПП
	                |ИЗ
	                |	ВТПремии КАК ВТПретензии
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	                |		ПО ВТПретензии.Договоры = ДоговорыКонтрагентов.Ссылка
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	                |		ПО ВТПретензии.Контрагент = Контрагенты.Ссылка
	                |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_му_ДоговорыКВзаимозачету.СрезПоследних(&ДатаОстатков, Организация = &Организация) КАК бит_му_ДоговорыКВзаимозачетуСрезПоследних
	                |		ПО ВТПретензии.Контрагент = бит_му_ДоговорыКВзаимозачетуСрезПоследних.Контрагент
	                |			И ВТПретензии.Договоры = бит_му_ДоговорыКВзаимозачетуСрезПоследних.Договор
	                |ГДЕ
	                |	бит_му_ДоговорыКВзаимозачетуСрезПоследних.ПогашениеВзаимозачетом = ИСТИНА
	                |	И Контрагенты.ИНН <> &ИННПустое
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	СУММА(ВТПретензии.СуммаМУОстаток) КАК СуммаМУОстаток,
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |ПОМЕСТИТЬ ВТПремииСИННКППГруппиров
	                |ИЗ
	                |	ВТПремии КАК ВТПретензии
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	                |		ПО ВТПретензии.Договоры = ДоговорыКонтрагентов.Ссылка
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	                |		ПО ВТПретензии.Контрагент = Контрагенты.Ссылка
	                |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_му_ДоговорыКВзаимозачету.СрезПоследних(&ДатаОстатков, Организация = &Организация) КАК бит_му_ДоговорыКВзаимозачетуСрезПоследних
	                |		ПО ВТПретензии.Контрагент = бит_му_ДоговорыКВзаимозачетуСрезПоследних.Контрагент
	                |			И ВТПретензии.Договоры = бит_му_ДоговорыКВзаимозачетуСрезПоследних.Договор
	                |ГДЕ
	                |	бит_му_ДоговорыКВзаимозачетуСрезПоследних.ПогашениеВзаимозачетом = ИСТИНА
	                |	И Контрагенты.ИНН <> &ИННПустое
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Контрагент,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТКЗПоТовару
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаКЗ, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТовару.Счет,
	                |	СУММА(ВТКЗПоТовару.СуммаМУОстаток) КАК СуммаМУОстаток,
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |ПОМЕСТИТЬ ВТКЗПоТоваруСИННКПП
	                |ИЗ
	                |	ВТКЗПоТовару КАК ВТКЗПоТовару
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	                |		ПО ВТКЗПоТовару.Контрагент = Контрагенты.Ссылка
	                |ГДЕ
	                |	Контрагенты.ИНН <> &ИННПустое
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	ВТКЗПоТовару.Счет,
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договор
	                |ПОМЕСТИТЬ ВТКЗПоТоваруСДоговорами
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаКЗ, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТоваруСДоговорами.Счет,
	                |	ВТКЗПоТоваруСДоговорами.Контрагент,
	                |	ВТКЗПоТоваруСДоговорами.Договор,
	                |	ВТКЗПоТоваруСДоговорами.СуммаМУОстаток,
	                |	ДоговорыКонтрагентов.бит_НомерАХ,
	                |	Контрагенты.ИНН,
	                |	Контрагенты.КПП
	                |ПОМЕСТИТЬ ВТКЗПоТоваруСДоговорамиСИННКПП
	                |ИЗ
	                |	ВТКЗПоТоваруСДоговорами КАК ВТКЗПоТоваруСДоговорами
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	                |		ПО ВТКЗПоТоваруСДоговорами.Договор = ДоговорыКонтрагентов.Ссылка
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	                |		ПО ВТКЗПоТоваруСДоговорами.Контрагент = Контрагенты.Ссылка
	                |ГДЕ
	                |	Контрагенты.ИНН <> &ИННПустое 
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ РАЗЛИЧНЫЕ
	                |	ВТПремииСИННКПП.Счет КАК СчетРасчетаПоПретензиям,
	                |	ВТПремииСИННКПП.Контрагент,
	                |	ВТПремииСИННКПП.Договоры КАК Договор,
	                |	ВТПремииСИННКПП.СуммаМУОстаток КАК СальдоПоСчетуРасчетаПоПретензиям,
	                |	ВТПремииСИННКПП.НомерАкс КАК ДоговорАксапты,
	                |	ВТПремииСИННКПП.ИНН КАК ИНН,
	                |	ВТПремииСИННКПП.КПП КАК КПП,
	                |	ВТПремииСИННКПП.Контрагент.НомДокИмпорт КАК КодКонтрагентаАксапты,
	                |	ВТПремииСИННКПП.Контрагент.Код КАК КодКонтрагента
	                |ИЗ
	                |	ВТПремииСИННКПП КАК ВТПремииСИННКПП
	                |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКЗПоТоваруСИННКПП КАК ВТКЗПоТоваруСИННКПП
	                |		ПО ВТПремииСИННКПП.КПП = ВТКЗПоТоваруСИННКПП.КПП
	                |			И ВТПремииСИННКПП.ИНН = ВТКЗПоТоваруСИННКПП.ИНН
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.Счет,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.Контрагент,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.Договор,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.СуммаМУОстаток,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.бит_НомерАХ,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.ИНН,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.КПП,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.Контрагент.НомДокИмпорт,
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП.Контрагент.Код
	                |ИЗ
	                |	ВТКЗПоТоваруСДоговорамиСИННКПП КАК ВТКЗПоТоваруСДоговорамиСИННКПП
	                |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПремииСИННКППГруппиров КАК ВТПремииСИННКППГруппиров
	                |		ПО ВТКЗПоТоваруСДоговорамиСИННКПП.ИНН = ВТПремииСИННКППГруппиров.ИНН
	                |			И ВТКЗПоТоваруСДоговорамиСИННКПП.КПП = ВТПремииСИННКППГруппиров.КПП
	                |
	                |УПОРЯДОЧИТЬ ПО
	                |	ИНН,
	                |	КПП";

	 	 
	Запрос.УстановитьПараметр("СчетУчетаДтПереносСальдо", СчетУчетаДЗПереносСальдо);	//52108					
	Запрос.УстановитьПараметр("СчетУчетаКЗ", СчетУчетаКЗ); //52101
	Запрос.УстановитьПараметр("СчетУчетаДЗРаботыУслуги", СчетУчетаДЗРаботыУслуги); //22102
	мПараметры = Новый Массив(2);
	мПараметры[0] = КонецДня(Объект.Дата);
	мПараметры[1] = ВидГраницы.Включая;
	Граница = Новый(Тип("Граница"),мПараметры);
	Запрос.УстановитьПараметр("ДатаОстатков", Граница);
	//Запрос.УстановитьПараметр("ДатаОстатков", КонецДня(Объект.Дата)+1);
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	Запрос.УстановитьПараметр("ИННПустое", "");
	
	Таблица = Запрос.Выполнить().Выгрузить();

	Возврат Таблица;				
	
КонецФункции

&НаСервере
Функция ПолучитьТаблицуПоПремиямПоМаркетингу()
	
	НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	НаборНастроек.Прочитать();
	
	ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();

	
	 СчетаУчетаДЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по премиям по договорам маркетинга"));
	 
	 Если СчетаУчетаДЗ.Количество() > 0 Тогда
		 СчетУчетаДЗ = СчетаУчетаДЗ[0].Значение;
	 КонецЕсли;
	 
	 СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	 
	 Если СчетаУчетаКЗ.Количество() > 0 Тогда
		 СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение;
	 КонецЕсли;
	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(бит_Дополнительный_2Остатки.СуммаМУОстаток) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТПретензии
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаДт, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТКЗПоТовару
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетУчетаКЗ, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТовару.Договоры КАК ДоговорКЗ,
	                |	ВТКЗПоТовару.Контрагент КАК КонтрагентКЗ,
	                |	ВЫБОР
	                |		КОГДА ВТКЗПоТовару.Счет ЕСТЬ NULL 
	                |			ТОГДА &СчетУчетаКЗ
	                |		ИНАЧЕ ВТКЗПоТовару.Счет
	                |	КОНЕЦ КАК СчетУчетаКЗ,
	                |	ВТПретензии.Счет КАК СчетРасчетаПоПретензиям,
	                |	ВТКЗПоТовару.СуммаМУОстаток КАК СальдоПоСчетуУчетаКЗ,
	                |	ВТПретензии.СуммаМУОстаток КАК СальдоПоСчетуРасчетаПоПретензиям,
	                |	ВЫБОР
	                |		КОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0) <= ВТПретензии.СуммаМУОстаток
	                |			ТОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0)
	                |		ИНАЧЕ ВТПретензии.СуммаМУОстаток
	                |	КОНЕЦ КАК СуммаСворачивания,
	                |	ВЫБОР
	                |		КОГДА ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0) > ВТПретензии.СуммаМУОстаток
	                |			ТОГДА 0
	                |		ИНАЧЕ ВТПретензии.СуммаМУОстаток - ЕСТЬNULL(ВТКЗПоТовару.СуммаМУОстаток, 0)
	                |	КОНЕЦ КАК СуммаОтнесения,
	                |	ВТПретензии.Договоры КАК Договор,
	                |	ВТПретензии.Контрагент КАК Контрагент,
	                |	ВТПретензии.Контрагент.Код КАК КодКонтрагента
	                |ИЗ
	                |	ВТПретензии КАК ВТПретензии
	                |		ЛЕВОЕ СОЕДИНЕНИЕ ВТКЗПоТовару КАК ВТКЗПоТовару
	                |		ПО ВТПретензии.Договоры = ВТКЗПоТовару.Договоры";

	Запрос.УстановитьПараметр("СчетУчетаДт", СчетУчетаДЗ);						
	Запрос.УстановитьПараметр("СчетУчетаКЗ", СчетУчетаКЗ);
	мПараметры = Новый Массив(2);
	мПараметры[0] = КонецДня(Объект.Дата);
	мПараметры[1] = ВидГраницы.Включая;
	Граница = Новый(Тип("Граница"),мПараметры);
	Запрос.УстановитьПараметр("ДатаОстатков", Граница);
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Таблица = Запрос.Выполнить().Выгрузить();

	Возврат Таблица;
	
КонецФункции

&НаСервере
Функция ПолучитьТаблицуПоУслугам()
	
	 НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	 НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	 НаборНастроек.Прочитать();
	 
	 ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();
	 
	 СчетаРасчетаПоПретензиям = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по работам и услугам"));
	 
	 Если СчетаРасчетаПоПретензиям.Количество() > 0 Тогда
		 СчетРасчетаПоПретензиям = СчетаРасчетаПоПретензиям[0].Значение;
	 КонецЕсли;
	 
	 СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	 
	 Если СчетаРасчетаПоПретензиям.Количество() > 0 Тогда
	 	СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение;
	 КонецЕсли;

	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = "ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТПретензии
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетПретензий, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты) КАК Контрагент,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ КАК Договоры,
	                |	СУММА(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Активный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |			КОГДА бит_Дополнительный_2Остатки.Счет.Вид = ЗНАЧЕНИЕ(ВидСчета.Пассивный)
	                |				ТОГДА бит_Дополнительный_2Остатки.СуммаМУОстаток * -1
	                |			ИНАЧЕ бит_Дополнительный_2Остатки.СуммаМУОстаток
	                |		КОНЕЦ) КАК СуммаМУОстаток
	                |ПОМЕСТИТЬ ВТКЗПоТовару
	                |ИЗ
	                |	РегистрБухгалтерии.бит_Дополнительный_2.Остатки(&ДатаОстатков, Счет = &СчетКЗПоТовару, , Организация = &Организация) КАК бит_Дополнительный_2Остатки
	                |
	                |СГРУППИРОВАТЬ ПО
	                |	бит_Дополнительный_2Остатки.Счет,
	                |	ВЫБОР
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |		КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.ДоговорыКонтрагентов
	                |				И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	                |			ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |	КОНЕЦ,
	                |	ВЫРАЗИТЬ(ВЫБОР
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто1 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто1 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто1
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто2 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто2 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто2
	                |			КОГДА бит_Дополнительный_2Остатки.Субконто3 ССЫЛКА Справочник.Контрагенты
	                |					И НЕ бит_Дополнительный_2Остатки.Субконто3 = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	                |				ТОГДА бит_Дополнительный_2Остатки.Субконто3
	                |		КОНЕЦ КАК Справочник.Контрагенты)
	                |;
	                |
	                |////////////////////////////////////////////////////////////////////////////////
	                |ВЫБРАТЬ
	                |	ВТКЗПоТовару.Договоры КАК Договор,
	                |	ВТКЗПоТовару.Контрагент,
	                |	ВТКЗПоТовару.Счет КАК СчетУчетаКЗ,
	                |	ВТПретензии.Счет КАК СчетРасчетаПоПретензиям,
	                |	ВТКЗПоТовару.СуммаМУОстаток КАК СальдоПоСчетуУчетаКЗ,
	                |	ВТПретензии.СуммаМУОстаток КАК СальдоПоСчетуРасчетаПоПретензиям,
	                |	ВЫБОР
	                |		КОГДА ВТКЗПоТовару.СуммаМУОстаток < ВТПретензии.СуммаМУОстаток
	                |			ТОГДА ВТКЗПоТовару.СуммаМУОстаток
	                |		ИНАЧЕ ВТПретензии.СуммаМУОстаток
	                |	КОНЕЦ КАК СуммаСворачивания,
	                |	ВТПретензии.Договоры,
	                |	ВТКЗПоТовару.Контрагент.Код КАК КодКонтрагента
	                |ИЗ
	                |	ВТПретензии КАК ВТПретензии
	                |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКЗПоТовару КАК ВТКЗПоТовару
	                |		ПО ВТПретензии.Договоры = ВТКЗПоТовару.Договоры";
					
	Запрос.УстановитьПараметр("СчетПретензий", СчетРасчетаПоПретензиям);						
	Запрос.УстановитьПараметр("СчетКЗПоТовару", СчетУчетаКЗ);
	мПараметры = Новый Массив(2);
	мПараметры[0] = КонецДня(Объект.Дата);
	мПараметры[1] = ВидГраницы.Включая;
	Граница = Новый(Тип("Граница"),мПараметры);
	Запрос.УстановитьПараметр("ДатаОстатков", Граница);
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Таблица = Запрос.Выполнить().Выгрузить();

	Возврат Таблица; 
	     	
КонецФункции

&НаКлиенте
Процедура РассчитатьОбщиеСуммы();
	
	СуммаСвр = 0;
	СуммаОтн = 0;
	Для Каждого Строка Из Объект.ТЧПретензии Цикл
		СуммаСвр = СуммаСвр + Строка.СуммаСворачивания;
		СуммаОтн = СуммаОтн + Строка.СуммаОтнесения;
	КонецЦикла;
	
	Объект.СуммаОтнесения = СуммаОтн;
	Объект.СуммаСворачивания = СуммаСвр;
	
КонецПроцедуры

&НаСервере
Процедура НастроитьТабличнуюЧастьПоВидамОперации()
	
	Если Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПретензиям Тогда
		
		Элементы.ТЧПретензииСуммаОтнесения.Видимость = ЛОЖЬ;
		
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамПоставки Тогда
		
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Заголовок = "Счет ДЗ по премиям по договорам поставки";
		Элементы.ТЧПретензииСчетУчетаКЗ.Заголовок = "Счет учета КЗ по товару";
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Заголовок = "Сальдо по счету ДЗ по премиям по договорам поставки на дату документа";
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Заголовок = "Сальдо по счету КЗ по товару на дату документа";
		
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоПремиямПоДоговорамМаркетинга Тогда
		
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Заголовок = "Счет расчетов по премиям по договорам маркетинга";
		Элементы.ТЧПретензииСчетУчетаКЗ.Заголовок = "Счет учета КЗ по товару";
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Заголовок = "Сальдо по счету расчетов по премиям по договорам маркетинга на дату документа";
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Заголовок = "Сальдо по счету КЗ по товару на дату документа";		
		
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.СворачиваниеЗадолженностиПоУслугам Тогда
		
		Элементы.ТЧПретензииСуммаОтнесения.Видимость = ЛОЖЬ;
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Заголовок = "Счет расчетов по ДЗ по работам и услугам";
		Элементы.ТЧПретензииСчетУчетаКЗ.Заголовок = "Счет учета КЗ по товару";
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Заголовок = "Сальдо по счету ДЗ по работам и услугам на дату документа";
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Заголовок = "Сальдо по счету КЗ по товару на дату документа";
		
	ИначеЕсли Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ПереносСальдоНаОдинДоговорДляСворачиванияЗадолженности Тогда
		
		Элементы.ТЧПретензииКодКонтрагентаАксапты.Видимость = Истина;
		Элементы.ТЧПретензииИНН.Видимость = Истина;
		Элементы.ТЧПретензииКПП.Видимость = Истина;
		Элементы.ТЧПретензииДоговорАксапты.Видимость = Истина;
		
		Элементы.ТЧПретензииСчетУчетаКЗ.Видимость = Ложь;
		Элементы.ТЧПретензииСуммаОтнесения.Видимость = Ложь;
		
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Заголовок = "Счет МСФО";
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Заголовок = "Сальдо до переноса";
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Заголовок = "Сальдо после переноса";
		Элементы.ТЧПретензииСуммаСворачивания.Заголовок = "Сумма переноса";
		
		Элементы.ТЧПретензии.ИзменятьПорядокСтрок = Истина;
		ПереместитьЭлементыНаСервере();
		
		Элементы.Рассчитать.Видимость = Истина;
		
		Если Объект.ТЧПретензии.Количество() > 0 И НЕ Объект.Рассчитано Тогда
			Элементы.ТЧПретензии.ИзменятьСоставСтрок = Истина;
		КонецЕсли;
		
		Элементы.СуммаОтнесения.Видимость = Ложь;
		Элементы.СуммаСворачивания.Заголовок = "Сумма переноса";
		
	КонецЕсли;
	
	Если НЕ Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ПереносСальдоНаОдинДоговорДляСворачиванияЗадолженности Тогда
		
	КонецЕсли;
	
	// ОКЕЙ Чернов И.Е.(СофтЛаб) Начало 2019-05-15 (#3440)
	Если Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносОтрицательногоСальдоПоЗадолженностиВВалюте ИЛИ
		Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносОтрицательногоСальдоПоЗадолженностиВРублях Тогда
		Элементы.ДатаСторно.ТолькоПросмотр = Ложь;
		нЭлемент = Элементы.Добавить("ок_Провести", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_Провести"; 
		нЭлемент = Элементы.Добавить("ок_Сторнировать", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_Сторнировать";
		нЭлемент = Элементы.Добавить("ок_СальдоПоСчетуУчетаДЗ", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_СальдоПоСчетуУчетаДЗ";
		нЭлемент.Заголовок = "Сальдо по счету";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ТЧПретензииСчетУчетаКЗ);
		нЭлемент = Элементы.Добавить("ок_СчетУчетаДЗ", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_СчетУчетаДЗ";
		нЭлемент.Заголовок = "Счет учета МСФО";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ок_СальдоПоСчетуУчетаДЗ);
		нЭлемент = Элементы.Добавить("ок_КодДоговора", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_КодДоговора";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ок_СчетУчетаДЗ);
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Видимость = Ложь;
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Видимость = Ложь;
		Элементы.ТЧПретензииСуммаСворачивания.Видимость = Ложь;
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Видимость = Ложь;
		Элементы.ТЧПретензииСчетУчетаКЗ.Заголовок = "Счет переноса";
		Элементы.Переместить(Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям, Элементы.ТЧПретензии, Элементы.ТЧПретензииСуммаОтнесения);
		Элементы.ТЧПретензииСуммаОтнесения.Видимость = ЛОЖЬ;
		нРеквизиты = Новый Массив;
		нРеквизиты.Добавить(Новый РеквизитФормы("ВсеОтметки", Новый ОписаниеТипов("Булево"), "Объект.ТЧПретензии", "Все отметки", Истина));
		ИзменитьРеквизиты(нРеквизиты);
		нЭлемент = Элементы.Добавить("ВсеОтметки", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ВсеОтметки"; 
		нЭлемент.УстановитьДействие("ПриИзменении", "ВсеОтметкиПриИзменении");
		УсловноеОформление.Элементы.Очистить();
		Элементы.ТЧПретензииСчетУчетаКЗ.ТолькоПросмотр = Ложь;
		ЭлементОформления = УсловноеОформление.Элементы.Добавить();
		ЭлементОтбора = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ТЧПретензии.РучнаяКорректировка");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = Ложь;
		ЭлементОтбора.Использование = Истина;
		ЭлементОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
		ПолеОформления = ЭлементОформления.Поля.Элементы.Добавить();
		ПолеОформления.Поле = Новый ПолеКомпоновкиДанных("ТЧПретензииСчетУчетаКЗ");
		ПолеОформления.Использование = Истина;
	КонецЕсли;
	Если Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносСальдоНаОдинДоговорСУчетомКодовМСФОВВалюте ИЛИ
		Объект.ВидОперации = Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносСальдоНаОдинДоговорСУчетомКодовМСФОВРублях Тогда		
		Элементы.ДатаСторно.ТолькоПросмотр = Ложь;
		нЭлемент = Элементы.Добавить("ок_Провести", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_Провести"; 
		нЭлемент = Элементы.Добавить("ок_Сторнировать", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_Сторнировать";
		нЭлемент = Элементы.Добавить("ок_СальдоПоСчетуУчетаДЗ", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_СальдоПоСчетуУчетаДЗ";
		нЭлемент.ТолькоПросмотр = Истина;
		нЭлемент.Заголовок = "Сумма сальдо ДЗ";
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ТЧПретензииСчетУчетаКЗ);
		нЭлемент = Элементы.Добавить("ок_СчетУчетаДЗ", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_СчетУчетаДЗ";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ок_СальдоПоСчетуУчетаДЗ);
		нЭлемент = Элементы.Добавить("ок_КодМСФО", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_КодМСФО";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ок_СчетУчетаДЗ);
		нЭлемент = Элементы.Добавить("ок_КодДоговора", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеВвода; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ок_КодДоговора";
		нЭлемент.ТолькоПросмотр = Истина;
		Элементы.Переместить(нЭлемент, Элементы.ТЧПретензии, Элементы.ок_КодМСФО);
		Элементы.ТЧПретензииСчетРасчетаПоПретензиям.Видимость = Ложь;
		Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям.Заголовок = "Сальдо после переноса";
		Элементы.ТЧПретензииСуммаСворачивания.Заголовок = "Сумма переноса";
		Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ.Заголовок = "Сумма сальдо КЗ";
		Элементы.Переместить(Элементы.ТЧПретензииСальдоПоСчетуРасчетаПоПретензиям, Элементы.ТЧПретензии, Элементы.ТЧПретензииСуммаОтнесения);
		Элементы.ТЧПретензииСуммаОтнесения.Видимость = ЛОЖЬ;
		нРеквизиты = Новый Массив;
		нРеквизиты.Добавить(Новый РеквизитФормы("ВсеОтметки", Новый ОписаниеТипов("Булево"), "Объект.ТЧПретензии", "Все отметки", Истина));
		ИзменитьРеквизиты(нРеквизиты);
		нЭлемент = Элементы.Добавить("ВсеОтметки", Тип("ПолеФормы"), Элементы.ТЧПретензии); 
		нЭлемент.Вид = ВидПоляФормы.ПолеФлажка; 
		нЭлемент.ПутьКДанным = "Объект.ТЧПретензии.ВсеОтметки"; 
		нЭлемент.УстановитьДействие("ПриИзменении", "ВсеОтметкиПриИзменении");
	КонецЕсли;
	// ОКЕЙ Чернов И.Е.(СофтЛаб) Конец 2019-05-15 (#3440)

КонецПроцедуры

&НаСервере
Процедура ПереместитьЭлементыНаСервере()
	
	Элементы.Переместить(Элементы.ТЧПретензииСуммаСворачивания, Элементы.ТЧПретензии, Элементы.ТЧПретензииСальдоПоСчетуУчетаКЗ);
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьТЧ(Команда)
	
	РассчитатьТЧНаСервере();
	
	Модифицированность = Истина;
	
	Объект.ТЧПретензии.Сортировать("ИНН возр, КПП возр");
	
	РассчитатьОбщиеСуммы();
	
	Объект.Рассчитано = Истина;
	
	УстановитьДоступностьДаты();
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьТЧНаСервере()
	
	НаборНастроек = РегистрыСведений.бит_му_Настройки.СоздатьНаборЗаписей();
	НаборНастроек.Отбор.Группа.Установить("Вспомогательные счета сворачивания");
	НаборНастроек.Прочитать();
	
	ТаблицаВспомогательныхСчетов = НаборНастроек.Выгрузить();
	
	ТаблицаСтрок = Объект.ТЧПретензии.Выгрузить();
	
	СчетаУчетаКЗ = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет учета КЗ по товару"));
	
	Если СчетаУчетаКЗ.Количество() > 0 Тогда
		СчетУчетаКЗ = СчетаУчетаКЗ[0].Значение; //52101
	КонецЕсли;
	
	СчетаУчетаДЗРаботыУслуги = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по работам и услугам"));
	
	Если СчетаУчетаДЗРаботыУслуги.Количество() > 0 Тогда
		СчетУчетаДЗРаботыУслуги = СчетаУчетаДЗРаботыУслуги[0].Значение; //22102
	КонецЕсли;
	
	СчетаУчетаДЗПереносСальдо = ТаблицаВспомогательныхСчетов.НайтиСтроки(Новый Структура("ИмяНастройки","Счет ДЗ по премиям по договорам маркетинга"));
	
	Если СчетаУчетаДЗПереносСальдо.Количество() > 0 Тогда
		СчетУчетаДЗПереносСальдо = СчетаУчетаДЗПереносСальдо[0].Значение; //52108
	КонецЕсли;
	
	
	//получим контрагентов
	КонтрагентыЗапрос = Новый Запрос;
	КонтрагентыЗапрос.Текст ="ВЫБРАТЬ
	                         |	ТаблицаСтрок.ИНН,
	                         |	ТаблицаСтрок.КПП
	                         |ПОМЕСТИТЬ ВТТаблицаСтрок
	                         |ИЗ
	                         |	&ТаблицаСтрок КАК ТаблицаСтрок
	                         |;
	                         |
	                         |////////////////////////////////////////////////////////////////////////////////
	                         |ВЫБРАТЬ
	                         |	ВТТаблицаСтрок.ИНН,
	                         |	ВТТаблицаСтрок.КПП
	                         |ИЗ
	                         |	ВТТаблицаСтрок КАК ВТТаблицаСтрок
	                         |
	                         |СГРУППИРОВАТЬ ПО
	                         |	ВТТаблицаСтрок.ИНН,
	                         |	ВТТаблицаСтрок.КПП" ;
	КонтрагентыЗапрос.УстановитьПараметр("ТаблицаСтрок", ТаблицаСтрок);							
	КонтрагентыЗапрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Контрагенты = КонтрагентыЗапрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаТаблицыСтрок Из ТаблицаСтрок Цикл
		СтрокаТаблицыСтрок.СуммаСворачивания = СтрокаТаблицыСтрок.СальдоПоСчетуРасчетаПоПретензиям;
		СтрокаТаблицыСтрок.СальдоПоСчетуУчетаКЗ = СтрокаТаблицыСтрок.СальдоПоСчетуРасчетаПоПретензиям - СтрокаТаблицыСтрок.СуммаСворачивания; 
	КонецЦикла;
	
	Для Каждого Контрагент Из Контрагенты Цикл
		
		Строки52101Запрос = Новый Запрос;
		Строки52101Запрос.Текст ="ВЫБРАТЬ *
								|ПОМЕСТИТЬ ВТТаблицаСтрок
								|ИЗ
								|	&ТаблицаСтрок КАК ТаблицаСтрок
								|ГДЕ
								|	ТаблицаСтрок.СчетРасчетаПоПретензиям = &Счет52101
								|   И ТаблицаСтрок.ИНН = &ИНН
								|   И ТаблицаСтрок.КПП = &КПП
								|;
								|
								|////////////////////////////////////////////////////////////////////////////////
								|ВЫБРАТЬ *
								|ИЗ
								|	ВТТаблицаСтрок КАК ВТТаблицаСтрок" ;
		Строки52101Запрос.УстановитьПараметр("ТаблицаСтрок", ТаблицаСтрок);							
		Строки52101Запрос.УстановитьПараметр("Счет52101", СчетУчетаКЗ);
		Строки52101Запрос.УстановитьПараметр("ИНН", Контрагент.ИНН);
		Строки52101Запрос.УстановитьПараметр("КПП", Контрагент.КПП);
		Строки52101Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Строки52101 = Строки52101Запрос.Выполнить().Выгрузить();
		
		ПараметрыОтбора = Новый Структура("ИНН, КПП");
		ПараметрыОтбора.ИНН = Контрагент.ИНН;
		ПараметрыОтбора.КПП = Контрагент.КПП;
		
		ТаблицаСтрокКонтрагент = ТаблицаСтрок.НайтиСтроки(ПараметрыОтбора);
		
		Если Строки52101.Количество() = 0 Тогда
			Сообщить("Для контрагента с ИНН: "+ Контрагент.ИНН+"Не определен счет 52101.", СтатусСообщения.Важное);
			Для Каждого СтрокаКонтрагента Из ТаблицаСтрокКонтрагент Цикл
				СтрокаКонтрагента.СуммаСворачивания = 0;
			КонецЦикла;
			Продолжить;
		КонецЕсли;
		
		Строки52101.Сортировать("СальдоПоСчетуРасчетаПоПретензиям Убыв", );
		
		СтрокаСМаксимальнымСальдо = Строки52101[0];
				
		ТаблицаСумм = ТаблицаСтрок.Скопировать(ПараметрыОтбора,"СчетРасчетаПоПретензиям, СальдоПоСчетуРасчетаПоПретензиям");
		ТаблицаСумм.Свернуть("СчетРасчетаПоПретензиям", "СальдоПоСчетуРасчетаПоПретензиям");
		
		Если ТаблицаСумм.Количество() < 2 Тогда
			Сообщить("Для контрагента с ИНН: "+ Контрагент.ИНН+" количество счетов сворачивания меньше двух.", СтатусСообщения.Важное);
			Для Каждого СтрокаКонтрагента Из ТаблицаСтрокКонтрагент Цикл
				СтрокаКонтрагента.СуммаСворачивания = 0;
			КонецЦикла;
			Продолжить;
		КонецЕсли;			
		
		СуммарныеСтроки52101 = ТаблицаСумм.Найти(СчетУчетаКЗ,"СчетРасчетаПоПретензиям");	
		
		ТаблицаСтрок[СтрокаСМаксимальнымСальдо.НомерСтроки - 1].СуммаСворачивания = (СуммарныеСтроки52101.СальдоПоСчетуРасчетаПоПретензиям - СтрокаСМаксимальнымСальдо.СальдоПоСчетуРасчетаПоПретензиям)*-1;
		ТаблицаСтрок[СтрокаСМаксимальнымСальдо.НомерСтроки - 1].СальдоПоСчетуУчетаКЗ = ТаблицаСтрок[СтрокаСМаксимальнымСальдо.НомерСтроки - 1].СальдоПоСчетуРасчетаПоПретензиям - ТаблицаСтрок[СтрокаСМаксимальнымСальдо.НомерСтроки - 1].СуммаСворачивания; 
		
		//добавим строку 52108
		СуммарныеСтроки52108 = ТаблицаСумм.Найти(СчетУчетаДЗПереносСальдо,"СчетРасчетаПоПретензиям");
		Если НЕ СуммарныеСтроки52108 = Неопределено Тогда
			НоваяСтрока52108 = ТаблицаСтрок.Добавить();
			НоваяСтрока52108.Контрагент = СтрокаСМаксимальнымСальдо.Контрагент;
			НоваяСтрока52108.КодКонтрагента = СтрокаСМаксимальнымСальдо.КодКонтрагента;
			НоваяСтрока52108.Договор = СтрокаСМаксимальнымСальдо.Договор;
			НоваяСтрока52108.КодКонтрагентаАксапты = СтрокаСМаксимальнымСальдо.КодКонтрагентаАксапты;
			НоваяСтрока52108.ИНН = СтрокаСМаксимальнымСальдо.ИНН;
			НоваяСтрока52108.КПП = СтрокаСМаксимальнымСальдо.КПП;
			НоваяСтрока52108.ДоговорАксапты = СтрокаСМаксимальнымСальдо.ДоговорАксапты;
			НоваяСтрока52108.СчетРасчетаПоПретензиям = СчетУчетаДЗПереносСальдо;
			НоваяСтрока52108.СуммаСворачивания = СуммарныеСтроки52108.СальдоПоСчетуРасчетаПоПретензиям * -1; 	
			НоваяСтрока52108.СальдоПоСчетуУчетаКЗ = НоваяСтрока52108.СальдоПоСчетуРасчетаПоПретензиям - НоваяСтрока52108.СуммаСворачивания; 
		КонецЕсли;
		
		//добавим строку 22102	
		СуммарныеСтроки22102 = ТаблицаСумм.Найти(СчетУчетаДЗРаботыУслуги,"СчетРасчетаПоПретензиям"); 
		Если НЕ СуммарныеСтроки22102 = Неопределено Тогда
			НоваяСтрока22102= ТаблицаСтрок.Добавить();
			НоваяСтрока22102.Контрагент = СтрокаСМаксимальнымСальдо.Контрагент;
			НоваяСтрока22102.КодКонтрагента = СтрокаСМаксимальнымСальдо.КодКонтрагента;
			НоваяСтрока22102.Договор = СтрокаСМаксимальнымСальдо.Договор;
			НоваяСтрока22102.КодКонтрагентаАксапты = СтрокаСМаксимальнымСальдо.КодКонтрагентаАксапты;
			НоваяСтрока22102.ИНН = СтрокаСМаксимальнымСальдо.ИНН;
			НоваяСтрока22102.КПП = СтрокаСМаксимальнымСальдо.КПП;
			НоваяСтрока22102.ДоговорАксапты = СтрокаСМаксимальнымСальдо.ДоговорАксапты;
			НоваяСтрока22102.СчетРасчетаПоПретензиям = СчетУчетаДЗРаботыУслуги;
			НоваяСтрока22102.СуммаСворачивания = СуммарныеСтроки22102.СальдоПоСчетуРасчетаПоПретензиям*-1; 
			НоваяСтрока22102.СальдоПоСчетуУчетаКЗ = НоваяСтрока22102.СальдоПоСчетуРасчетаПоПретензиям - НоваяСтрока22102.СуммаСворачивания; 
		КонецЕсли; 	
		
		ЗначениеВДанныеФормы(ТаблицаСтрок, Объект.ТЧПретензии);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	Объект.ДатаСторно = НачалоМесяца(Дата(Год(ДобавитьМесяц(Объект.Дата,1)), Месяц(ДобавитьМесяц(Объект.Дата,1)), 1));
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	УстановитьЗаголовокФормыДокумента();
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьТЧ(Команда)
	
	Если Объект.Проведен Тогда
		ПоказатьПредупреждение(Новый ОписаниеОповещения("ОчиститьТЧЗавершение", ЭтотОбъект), "Перед очисткой таблицы требуется распровести документ", 5);
        Возврат;
	Иначе
		Объект.ТЧПретензии.Очистить();
		Объект.СуммаОтнесения = 0;
		Объект.СуммаСворачивания = 0;
		Модифицированность = Истина;
	КонецЕсли;
	
	ОчиститьТЧФрагмент();
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьТЧЗавершение(ДополнительныеПараметры) Экспорт
    
    ОчиститьТЧФрагмент();

КонецПроцедуры

&НаКлиенте
Процедура ОчиститьТЧФрагмент()
    
    Объект.Рассчитано = Ложь;
    
    УстановитьДоступностьДаты();

КонецПроцедуры

&НаКлиенте
Процедура ТЧПретензииПриИзменении(Элемент)
	
	РассчитатьОбщиеСуммы();
	
КонецПроцедуры

&НаКлиенте
Процедура ТЧПретензииПередУдалением(Элемент, Отказ)
	
	Если Объект.Рассчитано ИЛИ НЕ Элемент.ТекущиеДанные.РучнаяКорректировка Тогда
		 Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТЧПретензииСуммаСворачиванияПриИзменении(Элемент)
	
	Если Объект.ВидОперации = фКэшЗначений.Перечисления.бит_му_ВидыОперацийСворачиваниеЗадолженности.ПереносСальдоНаОдинДоговорДляСворачиванияЗадолженности Тогда
		 Элементы.ТЧПретензии.ТекущиеДанные.СальдоПоСчетуУчетаКЗ = Элементы.ТЧПретензии.ТекущиеДанные.СальдоПоСчетуРасчетаПоПретензиям - Элементы.ТЧПретензии.ТекущиеДанные.СуммаСворачивания; 
		 
		 Сообщить("В случае необходимости откорректируйте сумму переноса в других строках для данной пары ИНН + КПП", СтатусСообщения.Внимание);
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьДоступностьДаты()
	
	Элементы.Дата.ТолькоПросмотр = НЕ Объект.ТЧПретензии.Количество() = 0;	
	
КонецПроцедуры

&НаКлиенте
Процедура ТЧПретензииПослеУдаления(Элемент)
	
	УстановитьДоступностьДаты();
	
КонецПроцедуры

// ОКЕЙ Чернов И.Е.(СофтЛаб) Начало 2019-05-15 (#3440)
&НаКлиенте
Процедура ВсеОтметкиПриИзменении(Элемент)
	ТекДанные = Элементы.ТЧПретензии.ТекущиеДанные;
	Если ТекДанные <> Неопределено Тогда
		ТекДанные.ок_Провести = ТекДанные.ВсеОтметки;
		ТекДанные.ок_Сторнировать = ТекДанные.ВсеОтметки;
	КонецЕсли;
КонецПроцедуры


&НаКлиенте
Процедура ТЧПретензииРучнаяКорректировкаПриИзменении(Элемент)
	ТекущиеДанные = Элементы.ТЧПретензии.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносОтрицательногоСальдоПоЗадолженностиВВалюте") ИЛИ
		Объект.ВидОперации = ПредопределенноеЗначение("Перечисление.бит_му_ВидыОперацийСворачиваниеЗадолженности.ок_ПереносОтрицательногоСальдоПоЗадолженностиВРублях") Тогда
		Если НЕ ТекущиеДанные.РучнаяКорректировка Тогда 
			ТекущиеДанные.СчетУчетаКЗ = ТекущиеДанные.СчетРасчетаПоПретензиям;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
// ОКЕЙ Чернов И.Е.(СофтЛаб) Конец 2019-05-15 (#3440)
